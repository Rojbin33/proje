import os
import random
import sqlite3
import discord
from discord.ext import commands
from discord import Intents
from dotenv import load_dotenv
from discord.ui import View, Button, Modal, TextInput

load_dotenv()
DISCORD_TOKEN = ""

intents = Intents.default()
intents.message_content = True
bot = commands.Bot(command_prefix="!", intents=intents)

# ------------------ VERƒ∞TABANI ------------------

conn = sqlite3.connect("games.db")
c = conn.cursor()

c.execute("""
CREATE TABLE IF NOT EXISTS games (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT UNIQUE,
    description TEXT,
    genre TEXT,
    platform TEXT,
    popularity INTEGER DEFAULT 0
)
""")

c.execute("""
CREATE TABLE IF NOT EXISTS steam (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    steam_ad TEXT UNIQUE,
    aciklama TEXT
)
""")

conn.commit()

# ------------------ YAPAY ZEKA TARZI CEVAP ------------------

def ai_style_reply(game):
    openings = ["Hƒ±mm‚Ä¶ bunu d√º≈ü√ºnd√ºm.", "Uzman modumu a√ßtƒ±m üòé", "Sava≈ü alanƒ±nƒ± tarƒ±yorum‚Ä¶"]
    opinions = ["Bu oyun √∂ne √ßƒ±kƒ±yor √ß√ºnk√º", "Oyuncularƒ±n en sevdiƒüi yanƒ±"]
    closings = ["ƒ∞stersen benzer oyun da √∂nerebilirim.", "Daha fazla detay istersen s√∂yle."]

    name, desc, genre, platform, pop = game
    return (
        f"{random.choice(openings)}\n"
        f"{name} oyununa baktƒ±m. {random.choice(opinions)} {desc.lower()}.\n"
        f"T√ºr√º: {genre}\n"
        f"Platform: {platform}\n"
        f"Pop√ºlerlik: {pop}\n"
        f"{random.choice(closings)}"
    )

# ------------------ KOMUTLAR ------------------

@bot.command()
async def game(ctx, *, isim):
    row = c.execute(
        "SELECT name, description, genre, platform, popularity FROM games WHERE LOWER(name)=LOWER(?)",
        (isim,)
    ).fetchone()
    if not row:
        await ctx.send(f'"{isim}" bulunamadƒ±.')
        return

    await ctx.send(ai_style_reply(row))
    c.execute("UPDATE games SET popularity = popularity + 1 WHERE name = ?", (isim,))
    conn.commit()

@bot.command()
async def top(ctx, adet: int = 7):
    rows = c.execute(
        "SELECT name, description, genre, platform, popularity FROM games ORDER BY popularity DESC LIMIT ?",
        (adet,)
    ).fetchall()
    if not rows:
        await ctx.send("Veritabanƒ±nda oyun yok.")
        return

    msg = "**En Pop√ºler Oyunlar:**\n"
    for i, r in enumerate(rows):
        msg += f"#{i+1} {r[0]} ({r[4]} oynanma)\n"
    await ctx.send(msg)

@bot.command()
async def ara(ctx, *, kelime):
    kelime = f"%{kelime.lower()}%"
    rows = c.execute("SELECT name FROM games WHERE LOWER(name) LIKE ?", (kelime,)).fetchall()
    if not rows:
        await ctx.send("Benzer oyun bulunamadƒ±.")
        return

    msg = "**Bulunan Oyunlar:**\n" + "\n".join([r[0] for r in rows])
    await ctx.send(msg)

@bot.command()
async def rastgele(ctx):
    row = c.execute(
        "SELECT name, description, genre, platform, popularity FROM games ORDER BY RANDOM() LIMIT 1"
    ).fetchone()
    if not row:
        await ctx.send("Veritabanƒ±nda oyun yok.")
        return

    await ctx.send(ai_style_reply(row))

@bot.command()
async def bilgi(ctx):
    await ctx.send("üî• GameFinder Bot v5.0\nKomutlar: !game, !top, !ara, !rastgele, !menu, !hesabƒ±mƒ±_ekle")

# ------------------ MODAL (FORM) ------------------

class AddGameModal(Modal, title="Yeni Oyun Ekle"):
    isim = TextInput(label="Oyun Adƒ±", placeholder="√ñrn: Valorant")
    genre = TextInput(label="T√ºr√º", placeholder="FPS, RPG, Strateji...")
    platform = TextInput(label="Platform", placeholder="PC, PS, Xbox...")
    description = TextInput(label="A√ßƒ±klama", style=discord.TextStyle.long, placeholder="Oyun a√ßƒ±klamasƒ±...")

    async def on_submit(self, interaction: discord.Interaction):
        try:
            c.execute(
                "INSERT INTO games (name, description, genre, platform) VALUES (?,?,?,?)",
                (self.isim.value, self.description.value, self.genre.value, self.platform.value),
            )
            conn.commit()
            await interaction.response.send_message(f"‚úî Oyun eklendi: **{self.isim.value}**", ephemeral=True)
        except:
            await interaction.response.send_message("‚ùå Bu oyun zaten var veya hata olu≈ütu.", ephemeral=True)

# ------------------ STEAM HESAP EKLE ------------------

@bot.command()
@commands.has_permissions(administrator=True)  # Yalnƒ±zca adminler kullanabilir
async def hesabƒ±mƒ±_ekle(ctx, steam_ad, *, aciklama="A√ßƒ±klama yok"):
    try:
        c.execute(
            "INSERT INTO steam (steam_ad, aciklama) VALUES (?, ?)",
            (steam_ad, aciklama)
        )
        conn.commit()
        await ctx.send(f"‚úî Yeni hesap eklendi: **{steam_ad}**")
    except sqlite3.IntegrityError:
        await ctx.send("‚ùå Bu hesap zaten var.")
    except Exception as e:
        await ctx.send(f"‚ùå Hata olu≈ütu: {e}")

# ------------------ BUTTON MENU ------------------

class MenuButtons(View):
    def __init__(self):
        super().__init__(timeout=None)
        self.add_item(Button(label="üéÆ Rastgele Oyun", style=discord.ButtonStyle.green, custom_id="random_game"))
        self.add_item(Button(label="üî• Pop√ºlerler", style=discord.ButtonStyle.blurple, custom_id="top_games"))
        self.add_item(Button(label="üîé Oyun Arama", style=discord.ButtonStyle.gray, custom_id="search_game"))
        self.add_item(Button(label="‚ûï Oyun Ekle", style=discord.ButtonStyle.success, custom_id="add_game"))
        self.add_item(Button(label="‚ÑπÔ∏è Bilgi", style=discord.ButtonStyle.red, custom_id="bot_info"))

@bot.command()
async def menu(ctx):
    embed = discord.Embed(
        title="üéõÔ∏è Oyun Men√ºs√º",
        description="A≈üaƒüƒ±daki butonlardan birini se√ß:",
        color=0x00ffcc
    )
    await ctx.send(embed=embed, view=MenuButtons())

# ------------------ INTERACTION HANDLER ------------------

@bot.event
async def on_interaction(interaction):
    cid = interaction.data.get("custom_id")

    if cid == "random_game":
        row = c.execute("SELECT name, description, genre, platform, popularity FROM games ORDER BY RANDOM() LIMIT 1").fetchone()
        await interaction.response.send_message(ai_style_reply(row), ephemeral=True)

    elif cid == "top_games":
        rows = c.execute("SELECT name, popularity FROM games ORDER BY popularity DESC LIMIT 5").fetchall()
        msg = "**üî• En Pop√ºler 5 Oyun:**\n"
        for i, r in enumerate(rows):
            msg += f"#{i+1} {r[0]} ‚Äî {r[1]} g√∂r√ºnt√ºleme\n"
        await interaction.response.send_message(msg, ephemeral=True)

    elif cid == "search_game":
        await interaction.response.send_message("üîé Aramak i√ßin `!ara oyun_adƒ±` yaz.", ephemeral=True)

    elif cid == "add_game":
        await interaction.response.send_modal(AddGameModal())

    elif cid == "bot_info":
        await interaction.response.send_message("ü§ñ GameFinder v5.0 | Men√º + Form + Steam sistemi aktif!", ephemeral=True)

print("Bot Hazƒ±r!")
bot.run(DISCORD_TOKEN)
